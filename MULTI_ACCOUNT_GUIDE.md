# 複数アカウント管理機能ガイド

## 概要

AI News Auto Tweeterに複数のX（Twitter）アカウントを登録・管理し、それぞれに異なるスケジュールで自動投稿できる機能が追加されました。

## 主な機能

### 1. 複数アカウント管理
- **アカウント登録**: X APIの認証情報を入力して複数のアカウントを登録
- **アカウント一覧表示**: 登録済みのすべてのアカウントを表示
- **認証状態確認**: 各アカウントのAPI認証が有効かどうかを確認
- **アカウント削除**: 不要なアカウントを削除

### 2. アカウント別スケジュール設定
- **投稿頻度の選択**:
  - 毎時間
  - 3時間ごと
  - 6時間ごと
  - 毎日（指定時刻）
- **タイムゾーン設定**: 複数のタイムゾーンに対応
- **投稿数制限**: 1日あたりの最大投稿数を設定（1～20件）
- **スケジュール有効/無効**: スケジュールのオン/オフを切り替え

### 3. アカウント別投稿履歴
- 各アカウントの投稿履歴を個別に管理
- 投稿成功/失敗の状態を追跡
- 投稿日時とニュースソースを記録

## 使用方法

### ステップ1: アカウント管理ページへアクセス

1. ダッシュボードのサイドバーから「複数アカウント」をクリック
2. または、ブラウザで `/accounts` にアクセス

### ステップ2: 新しいアカウントを追加

1. 「アカウントを追加」ボタンをクリック
2. 以下の情報を入力:
   - **アカウント名**: 管理用の名前（例：「メインアカウント」）
   - **ハンドル**: X（Twitter）のハンドル（オプション）
   - **API Key**: X API Developer PortalのAPI Key
   - **API Secret**: X API Developer PortalのAPI Secret
   - **Access Token**: X API Developer PortalのAccess Token
   - **Access Token Secret**: X API Developer PortalのAccess Token Secret
3. 「追加」ボタンをクリック

### ステップ3: アカウント別スケジュールを設定

1. アカウント一覧から目的のアカウントを選択
2. 「スケジュール」ボタンをクリック
3. スケジュール設定ページで以下を設定:
   - **自動投稿スケジュール**: トグルで有効/無効を切り替え
   - **投稿頻度**: 投稿の頻度を選択
   - **投稿時刻**: 毎日投稿の場合、時刻を指定（0～23）
   - **タイムゾーン**: タイムゾーンを選択
   - **最大投稿数**: 1日あたりの最大投稿数を設定
4. 「スケジュール設定を保存」ボタンをクリック

### ステップ4: 認証確認

1. アカウント一覧から「認証確認」ボタンをクリック
2. API認証情報が有効かどうかが確認されます

## データベーススキーマ

### twitter_accounts テーブル
複数のX（Twitter）アカウント情報を保存

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | アカウントID（主キー） |
| userId | INTEGER | ユーザーID（外部キー） |
| accountName | VARCHAR(255) | アカウント名 |
| accountHandle | VARCHAR(255) | X（Twitter）のハンドル |
| apiKey | VARCHAR(255) | API Key |
| apiSecret | VARCHAR(255) | API Secret |
| accessToken | VARCHAR(255) | Access Token |
| accessTokenSecret | VARCHAR(255) | Access Token Secret |
| isActive | BOOLEAN | アカウントが有効か |
| isValid | BOOLEAN | API認証が有効か |
| lastVerifiedAt | TIMESTAMP | 最後に認証確認した日時 |
| createdAt | TIMESTAMP | 作成日時 |
| updatedAt | TIMESTAMP | 更新日時 |

### account_schedules テーブル
アカウント別のスケジュール設定を保存

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | スケジュールID（主キー） |
| accountId | INTEGER | アカウントID（外部キー） |
| userId | INTEGER | ユーザーID（外部キー） |
| isEnabled | BOOLEAN | スケジュールが有効か |
| frequency | ENUM | 投稿頻度（hourly, every_3_hours, every_6_hours, daily） |
| preferredHour | INTEGER | 投稿時刻（0～23） |
| timezone | VARCHAR(50) | タイムゾーン |
| maxTweetsPerDay | INTEGER | 1日あたりの最大投稿数 |
| cronExpression | VARCHAR(50) | CRON式 |
| lastRunAt | TIMESTAMP | 最後に実行した日時 |
| createdAt | TIMESTAMP | 作成日時 |
| updatedAt | TIMESTAMP | 更新日時 |

### tweet_history テーブル（拡張）
アカウント別の投稿履歴を追跡

| カラム名 | 型 | 説明 |
|---------|-----|------|
| accountId | INTEGER | アカウントID（新規追加） |
| ... | ... | その他のカラムは既存と同じ |

## API エンドポイント

### アカウント管理
- `accounts.list`: ユーザーのすべてのアカウントを取得
- `accounts.get`: 特定のアカウント情報を取得
- `accounts.create`: 新しいアカウントを追加
- `accounts.update`: アカウント情報を更新
- `accounts.delete`: アカウントを削除
- `accounts.verify`: アカウントのAPI認証を検証

### スケジュール管理
- `accountSchedules.get`: アカウント別スケジュール設定を取得
- `accountSchedules.save`: アカウント別スケジュール設定を保存

## スケジューラーエンジン

### 実装内容
- **複数アカウント対応**: 各アカウントのスケジュールを独立して管理
- **CRON式サポート**: node-cronライブラリを使用した柔軟なスケジューリング
- **自動初期化**: サーバー起動時にデータベースから有効なスケジュールを自動読み込み
- **エラーハンドリング**: スケジュール実行エラーをログに記録

### スケジューラー関数
- `startAccountScheduleJob(accountId, schedule)`: アカウント別スケジュールジョブを開始
- `stopAccountScheduleJob(accountId)`: アカウント別スケジュールジョブを停止
- `initializeAccountSchedules()`: データベースから有効なアカウントスケジュールを初期化
- `stopAllAccountJobs()`: すべてのアカウントジョブを停止

## 投稿フロー

1. **スケジュール実行**: 設定された時刻にスケジューラーが自動実行
2. **ニュース取得**: AI関連ニュースをNewsAPI.orgから取得
3. **要約生成**: LLMを使用してニュースを要約
4. **投稿実行**: X APIを使用してツイートを投稿
5. **履歴記録**: 投稿結果をデータベースに記録

## トラブルシューティング

### アカウント追加時のエラー

**「認証情報が無効です」**
- X API認証情報が正しいか確認してください
- API KeyとAPI Secretが正しく入力されているか確認
- Access TokenとAccess Token Secretが有効か確認

### スケジュールが実行されない

**「スケジュールが実行されていない」**
- スケジュール設定で「自動投稿スケジュール」が有効になっているか確認
- アカウントが「有効」かつ「認証済み」の状態か確認
- サーバーログでエラーメッセージを確認

### 投稿が失敗する

**「投稿に失敗しました」**
- X API認証情報が有効か「認証確認」ボタンで確認
- X APIのレート制限に達していないか確認
- ツイート内容が280文字以内か確認

## 設定例

### 例1: 複数アカウントで異なる時間に投稿

**アカウントA（メインアカウント）**
- 投稿頻度: 毎日
- 投稿時刻: 09:00（日本時間）
- タイムゾーン: Asia/Tokyo
- 最大投稿数: 5件

**アカウントB（サブアカウント）**
- 投稿頻度: 6時間ごと
- タイムゾーン: America/New_York
- 最大投稿数: 3件

### 例2: 24時間体制での投稿

**アカウントA**
- 投稿頻度: 毎日
- 投稿時刻: 00:00（UTC）
- タイムゾーン: UTC

**アカウントB**
- 投稿頻度: 毎日
- 投稿時刻: 08:00（Asia/Tokyo）
- タイムゾーン: Asia/Tokyo

**アカウントC**
- 投稿頻度: 毎日
- 投稿時刻: 16:00（America/New_York）
- タイムゾーン: America/New_York

## テスト

複数アカウント管理機能は以下のテストで検証されています：

```bash
pnpm test
```

テスト項目：
- アカウント管理API（CRUD操作）
- スケジュール設定の検証
- CRON式の生成
- タイムゾーンの検証
- 投稿頻度の検証

## 注意事項

1. **API認証情報の安全性**: API KeyとAPI Secretは安全に保管してください。本番環境では環境変数を使用してください。
2. **レート制限**: X APIのレート制限に注意してください。複数アカウントで同時投稿する場合は、投稿時間をずらしてください。
3. **ニュースソース**: ニュースはNewsAPI.orgから取得されます。APIキーが必要です。
4. **タイムゾーン**: タイムゾーンは正確に設定してください。間違ったタイムゾーンを設定すると、投稿時刻がずれます。

## 今後の改善予定

- [ ] アカウント別の投稿テンプレート設定
- [ ] 複数アカウントの投稿内容の自動差別化
- [ ] アカウント別の分析ダッシュボード
- [ ] 投稿スケジュールの可視化
- [ ] 投稿予約機能
